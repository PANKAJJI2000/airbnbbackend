<% layout("/layouts/boilerplate") %>

<div class="row mt-3">
  <div class="col-8 offset-2">
    <h3>Book <%= listing.title %></h3>
    
    <div class="card mb-3">
      <div class="row g-0">
        <div class="col-md-4">
          <img src="<%= listing.image.url %>" class="img-fluid rounded-start" alt="<%= listing.title %>">
        </div>
        <div class="col-md-8">
          <div class="card-body">
            <h5 class="card-title"><%= listing.title %></h5>
            <p class="card-text"><%= listing.description %></p>
            <p class="card-text"><strong>Price: ₹<%= listing.price.toLocaleString("en-IN") %> / night</strong></p>
            <p class="card-text"><small class="text-muted">Location: <%= listing.location %>, <%= listing.country %></small></p>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-body">
        <h5 class="card-title">Booking Details</h5>
        
        <form action="/listings/<%= listing._id %>/book" method="POST" novalidate class="needs-validation">
          <input type="hidden" id="duration" name="duration" value="">
          <input type="hidden" id="totalPriceInput" name="totalPrice" value="">
          
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="checkIn" class="form-label">Check-in Date</label>
              <input 
                type="date" 
                class="form-control" 
                id="checkIn" 
                name="checkIn" 
                required
                min="<%= new Date().toISOString().split('T')[0] %>"
              >
              <div class="invalid-feedback">
                Please provide a valid check-in date.
              </div>
            </div>
            <div class="col-md-6">
              <label for="checkOut" class="form-label">Check-out Date</label>
              <input 
                type="date" 
                class="form-control" 
                id="checkOut" 
                name="checkOut" 
                required
                min="<%= new Date().toISOString().split('T')[0] %>"
              >
              <div class="invalid-feedback">
                Please provide a valid check-out date.
              </div>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6">
              <label for="guests" class="form-label">Number of Guests</label>
              <select class="form-select" id="guests" name="guests" required>
                <option value="">Select guests</option>
                <option value="1">1 Guest</option>
                <option value="2">2 Guests</option>
                <option value="3">3 Guests</option>
                <option value="4">4 Guests</option>
                <option value="5">5 Guests</option>
                <option value="6">6+ Guests</option>
              </select>
              <div class="invalid-feedback">
                Please select number of guests.
              </div>
            </div>
            <div class="col-md-6">
              <label for="phoneNumber" class="form-label">Phone Number *</label>
              <input 
                type="tel" 
                class="form-control" 
                id="phoneNumber" 
                name="phoneNumber" 
                placeholder="Enter your phone number"
                required
                pattern="[0-9]{10,15}"
              >
              <div class="invalid-feedback">
                Please provide a valid phone number.
              </div>
            </div>
          </div>

          <div class="mb-3">
            <label for="specialRequests" class="form-label">Special Requests (Optional)</label>
            <textarea 
              class="form-control" 
              id="specialRequests" 
              name="specialRequests" 
              rows="3" 
              placeholder="Any special requests or requirements..."
              maxlength="500"
            ></textarea>
            <div class="form-text">Maximum 500 characters</div>
          </div>

          <div class="mb-3">
            <div class="card bg-light">
              <div class="card-body">
                <h6 class="card-title">Booking Summary</h6>
                <div id="bookingSummary">
                  <p class="mb-1">Price per night: ₹<%= listing.price.toLocaleString("en-IN") %></p>
                  <p class="mb-1" id="durationDisplay">Duration: Please select dates</p>
                  <hr>
                  <p class="mb-0" id="totalPrice"><strong>Total: Please select dates</strong></p>
                </div>
              </div>
            </div>
          </div>

          <div class="mb-3">
            <button type="submit" class="btn btn-success btn-lg w-100" id="bookButton" disabled>Book Now</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  // Form validation
  (function() {
    'use strict';
    window.addEventListener('load', function() {
      var forms = document.getElementsByClassName('needs-validation');
      var validation = Array.prototype.filter.call(forms, function(form) {
        form.addEventListener('submit', function(event) {
          const durationInput = document.getElementById('duration');
          const totalPriceInput = document.getElementById('totalPriceInput');
          
          if (form.checkValidity() === false || !durationInput.value || !totalPriceInput.value) {
            event.preventDefault();
            event.stopPropagation();
            alert('Please select valid check-in and check-out dates');
          }
          form.classList.add('was-validated');
        }, false);
      });
    }, false);
  })();

  // Price calculation
  function calculatePrice() {
    const checkIn = document.getElementById('checkIn').value;
    const checkOut = document.getElementById('checkOut').value;
    const pricePerNight = parseFloat("<%= listing.price %>");
    const bookButton = document.getElementById('bookButton');
    const durationInput = document.getElementById('duration');
    const totalPriceInput = document.getElementById('totalPriceInput');

    if (checkIn && checkOut) {
      const checkInDate = new Date(checkIn);
      const checkOutDate = new Date(checkOut);
      
      if (checkOutDate > checkInDate) {
        const timeDiff = checkOutDate.getTime() - checkInDate.getTime();
        const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
        const totalPrice = daysDiff * pricePerNight;
        
        // Update hidden inputs
        durationInput.value = daysDiff;
        totalPriceInput.value = totalPrice;
        
        // Update display
        document.getElementById('durationDisplay').textContent = `Duration: ${daysDiff} night${daysDiff > 1 ? 's' : ''}`;
        document.getElementById('totalPrice').innerHTML = `<strong>Total: ₹${totalPrice.toLocaleString("en-IN")}</strong>`;
        
        // Enable book button
        bookButton.disabled = false;
      } else {
        durationInput.value = '';
        totalPriceInput.value = '';
        document.getElementById('durationDisplay').textContent = 'Duration: Please select valid dates';
        document.getElementById('totalPrice').innerHTML = '<strong>Total: Please select valid dates</strong>';
        bookButton.disabled = true;
      }
    } else {
      durationInput.value = '';
      totalPriceInput.value = '';
      bookButton.disabled = true;
    }
  }

  // Add event listeners for date changes
  document.getElementById('checkIn').addEventListener('change', calculatePrice);
  document.getElementById('checkOut').addEventListener('change', calculatePrice);

  // Set minimum checkout date based on checkin
  document.getElementById('checkIn').addEventListener('change', function() {
    const checkInDate = this.value;
    const checkOutInput = document.getElementById('checkOut');
    
    if (checkInDate) {
      const minCheckOut = new Date(checkInDate);
      minCheckOut.setDate(minCheckOut.getDate() + 1);
      checkOutInput.min = minCheckOut.toISOString().split('T')[0];
      
      if (checkOutInput.value && checkOutInput.value <= checkInDate) {
        checkOutInput.value = '';
        calculatePrice();
      }
    }
  });
</script>

<style>
.booking-page {
  min-height: 100vh;
  background-color: #f8f9fa;
  padding: 2rem 0;
}

.property-section {
  background: white;
  border-radius: 12px;
  padding: 2rem;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.main-image {
  width: 100%;
  height: 400px;
  object-fit: cover;
}

.property-info i,
.amenities i {
  color: #e61e4d;
  margin-right: 0.5rem;
}

.booking-form-container {
  position: sticky;
  top: 20px;
}

.booking-form {
  border: none;
  border-radius: 12px;
}

.btn-danger {
  background: linear-gradient(to right, #e61e4d 0%, #e31c5f 50%, #d70466 100%);
  border: none;
}

.btn-danger:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(230, 30, 77, 0.3);
}

.card {
  border: none;
  border-radius: 12px;
  overflow: hidden;
}

.card-title {
  font-size: 1.25rem;
  font-weight: 500;
}

.card-text {
  margin-bottom: 0.5rem;
}

.form-label {
  font-weight: 500;
}

.invalid-feedback {
  font-size: 0.875rem;
}

.btn-success {
  background-color: #28a745;
  border-color: #28a745;
}

.btn-success:hover {
  background-color: #218838;
  border-color: #1e7e34;
}

@media (max-width: 991px) {
  .booking-form-container {
    position: static;
    margin-top: 2rem;
  }
}
</style>